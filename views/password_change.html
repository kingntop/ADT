<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change Password - Dams PLUS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>

<body class="bg-gray-100 dark:bg-gray-900 h-screen flex overflow-hidden transition-colors duration-300">

    <!-- Sidebar Container -->
    <!-- SIDEBAR -->

    <!-- Main Content -->
    <div class="flex-1 flex flex-col min-w-0 overflow-hidden">
        <!-- Header Container -->
        <!-- HEADER -->

        <!-- Content -->
        <main
            class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 dark:bg-gray-900 p-6 flex items-center justify-center transition-colors duration-300">

            <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-md w-full max-w-md transition-colors">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 text-center">Change Password</h2>

                <form id="changePasswordForm" class="space-y-6">
                    <!-- Current Password -->
                    <div>
                        <label for="currentPassword"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300">Current
                            Password</label>
                        <div class="relative mt-1">
                            <input type="password" id="currentPassword" name="currentPassword" required
                                class="w-full pl-3 pr-10 py-2 border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 dark:text-white transition-colors">
                        </div>
                    </div>

                    <!-- New Password -->
                    <div>
                        <label for="newPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300">New
                            Password</label>
                        <div class="relative mt-1">
                            <input type="password" id="newPassword" name="newPassword" required
                                class="w-full pl-3 pr-10 py-2 border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 dark:text-white transition-colors">
                        </div>
                    </div>

                    <!-- Confirm New Password -->
                    <div>
                        <label for="confirmPassword"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300">Confirm New
                            Password</label>
                        <div class="relative mt-1">
                            <input type="password" id="confirmPassword" name="confirmPassword" required
                                class="w-full pl-3 pr-10 py-2 border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 dark:text-white transition-colors">
                        </div>
                        <p id="matchError" class="text-sm text-red-500 mt-1 hidden">Passwords do not match</p>
                    </div>

                    <button type="submit"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded transition duration-200">
                        Update Password
                    </button>
                </form>

                <div id="message" class="mt-4 p-3 rounded hidden text-sm font-medium text-center"></div>
            </div>

        </main>
    </div>

    <script src="/js/layout.js"></script>
    <script>
        loadLayout(''); // No specific active menu item

        const form = document.getElementById('changePasswordForm');
        const messageEl = document.getElementById('message');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const matchError = document.getElementById('matchError');

        function validatePasswordMatch() {
            if (confirmPasswordInput.value && newPasswordInput.value !== confirmPasswordInput.value) {
                matchError.classList.remove('hidden');
                return false;
            } else {
                matchError.classList.add('hidden');
                return true;
            }
        }

        newPasswordInput.addEventListener('input', validatePasswordMatch);
        confirmPasswordInput.addEventListener('input', validatePasswordMatch);

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!validatePasswordMatch()) return;

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = newPasswordInput.value;

            messageEl.className = 'mt-4 p-3 rounded hidden text-sm font-medium text-center';
            messageEl.textContent = '';

            try {
                const response = await fetch('/auth/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ currentPassword, newPassword })
                });

                const data = await response.json();

                messageEl.textContent = data.message;
                messageEl.classList.remove('hidden');

                if (data.success) {
                    messageEl.classList.add('bg-green-100', 'text-green-800');
                    form.reset();
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 1000);
                } else {
                    messageEl.classList.add('bg-red-100', 'text-red-800');
                }
            } catch (error) {
                console.error('Error:', error);
                messageEl.textContent = 'An error occurred. Please try again.';
                messageEl.classList.remove('hidden', 'bg-green-100', 'text-green-800');
                messageEl.classList.add('bg-red-100', 'text-red-800');
            }
        });
    </script>
</body>

</html>