<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>대시보드 - Dams PLUS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>

<body class="bg-gray-100 dark:bg-gray-900 h-screen flex overflow-hidden transition-colors duration-300">

    <!-- Sidebar Container -->
    <!-- SIDEBAR -->

    <!-- Main Content -->
    <div class="flex-1 flex flex-col min-w-0 overflow-hidden">
        <!-- Header Container -->
        <!-- HEADER -->

        <!-- Content Scrollable -->
        <main
            class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 dark:bg-gray-900 p-6 transition-colors duration-300">

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <!-- Stats Card 1 -->
                <div
                    class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border-l-4 border-blue-500 transition-colors">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100 dark:bg-blue-900 text-blue-500 dark:text-blue-200">
                            <i class="fa-solid fa-users text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-500 dark:text-gray-400 font-medium">전체 직원수</p>
                            <p class="text-2xl font-semibold text-gray-800 dark:text-white" id="stat-total-emp">
                                Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Stats Card 2 -->
                <div
                    class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border-l-4 border-green-500 transition-colors">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100 dark:bg-green-900 text-green-500 dark:text-green-200">
                            <i class="fa-solid fa-building text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-500 dark:text-gray-400 font-medium">부서수</p>
                            <p class="text-2xl font-semibold text-gray-800 dark:text-white" id="stat-total-dept">
                                Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Stats Card 3 -->
                <div
                    class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border-l-4 border-purple-500 transition-colors">
                    <div class="flex items-center">
                        <div
                            class="p-3 rounded-full bg-purple-100 dark:bg-purple-900 text-purple-500 dark:text-purple-200">
                            <i class="fa-solid fa-dollar-sign text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-500 dark:text-gray-400 font-medium">평균 급여</p>
                            <p class="text-2xl font-semibold text-gray-800 dark:text-white" id="stat-avg-sal">Loading...
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                <!-- Chart 1: Emp per Dept (Pie) -->
                <div
                    class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">부서별 사원 수
                    </h3>
                    <div id="chartDeptEmp" class="w-full h-80"></div>
                </div>

                <!-- Chart 2: Emp per Job (Pie) -->
                <div
                    class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">직무별 사원 수</h3>
                    <div id="chartJobEmp" class="w-full h-80"></div>
                </div>

                <!-- Chart 3: Salary per Dept (Bar) -->
                <div
                    class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">부서별 급여 합계
                    </h3>
                    <div id="chartDeptSal" class="w-full h-80"></div>
                </div>

                <!-- Chart 4: Salary per Job (Bar) -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">직무별 급여 합계</h3>
                    <div id="chartJobSal" class="w-full h-80"></div>
                </div>

            </div>
        </main>
    </div>

    <script src="/js/layout.js"></script>
    <script>
        // Init Layout
        loadLayout('대시보드');

        // Initialize Charts (Wrapped in timeout to ensure DOM is ready/layout doesn't shift too much, though ECharts handles distinct containers well)
        setTimeout(() => {
            const chartDeptEmp = echarts.init(document.getElementById('chartDeptEmp'));
            const chartJobEmp = echarts.init(document.getElementById('chartJobEmp'));
            const chartDeptSal = echarts.init(document.getElementById('chartDeptSal'));
            const chartJobSal = echarts.init(document.getElementById('chartJobSal'));

            window.addEventListener('resize', () => {
                chartDeptEmp.resize();
                chartJobEmp.resize();
                chartDeptSal.resize();
                chartJobSal.resize();
            });

            async function loadData() {
                // 0. Load Total Employees
                try {
                    const res0 = await fetch('/api/stats/total_employee');
                    const data0 = await res0.json();
                    document.getElementById('stat-total-emp').textContent = data0.count;
                } catch (e) { console.error('Total Emp Error', e); }

                // 0.1 Load Total Departments
                try {
                    const resDept = await fetch('/api/stats/total_dept');
                    const dataDept = await resDept.json();
                    document.getElementById('stat-total-dept').textContent = dataDept.count;
                } catch (e) { console.error('Total Emp Error', e); }

                // 0.2 Load Avg Salary
                try {
                    const resSal = await fetch('/api/stats/avg_sal');
                    const dataSal = await resSal.json();
                    document.getElementById('stat-avg-sal').textContent = '$' + Number(dataSal.avg_sal).toLocaleString();
                } catch (e) { console.error('Avg Sal Error', e); }

                try {
                    // Update API paths to new routes
                    const res1 = await fetch('/api/stats/dept-emp');
                    const dataDeptEmp = await res1.json();
                    chartDeptEmp.setOption({
                        tooltip: { trigger: 'item' },
                        legend: { bottom: '0%' },
                        series: [{
                            type: 'pie',
                            radius: '70%',
                            data: dataDeptEmp.map(item => ({ value: item.count, name: item.dname })),
                            emphasis: { itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)' } }
                        }]
                    });

                    const res2 = await fetch('/api/stats/job-emp');
                    const dataJobEmp = await res2.json();
                    chartJobEmp.setOption({
                        tooltip: { trigger: 'item' },
                        legend: { bottom: '0%' },
                        series: [{
                            type: 'pie',
                            radius: ['40%', '70%'],
                            avoidLabelOverlap: false,
                            itemStyle: { borderRadius: 10, borderColor: '#fff', borderWidth: 2 },
                            data: dataJobEmp.map(item => ({ value: item.count, name: item.job }))
                        }]
                    });

                    const res3 = await fetch('/api/stats/dept-sal');
                    const dataDeptSal = await res3.json();
                    chartDeptSal.setOption({
                        tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                        xAxis: { type: 'category', data: dataDeptSal.map(item => item.dname) },
                        yAxis: { type: 'value' },
                        series: [{
                            data: dataDeptSal.map(item => item.total),
                            type: 'bar',
                            itemStyle: { color: '#3ba272' }
                        }]
                    });

                    const res4 = await fetch('/api/stats/job-sal');
                    const dataJobSal = await res4.json();
                    chartJobSal.setOption({
                        tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                        xAxis: { type: 'category', data: dataJobSal.map(item => item.job) },
                        yAxis: { type: 'value' },
                        series: [{
                            data: dataJobSal.map(item => item.total),
                            type: 'bar',
                            itemStyle: { color: '#5470c6' }
                        }]
                    });

                } catch (error) {
                    console.error("Error loading chart data:", error);
                }
            }
            loadData();
        }, 100);
    </script>
</body>

</html>